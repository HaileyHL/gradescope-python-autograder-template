#!/usr/bin/env bash
set -euo pipefail

# Replaced by make_assignment.sh
REPLACE_NAME
REPLACE_SOLUTION_DIR
REPLACE_REPO_NAME

# 1) System/setup (installs Python, pulls your private repo, installs deps)
bash setup.sh

ASSIGN_DIR="/autograder/$REPO_NAME/$NAME"
DEST="$ASSIGN_DIR/$SOLUTION_DIR"
SUB="/autograder/submission"

# 2) Prepare student's solution folder
rm -rf "$DEST"
mkdir -p "$DEST"

# If the student uploaded a folder named 'solution', use it; otherwise copy top-level .py files
if [ -d "$SUB/$SOLUTION_DIR" ]; then
  rsync -a --delete "$SUB/$SOLUTION_DIR"/ "$DEST"/
else
  shopt -s nullglob
  cp -f "$SUB"/*.py "$DEST"/ || true
  shopt -u nullglob
fi
touch "$DEST/__init__.py"   # make it importable as a package

# 3) Run tests (writes /autograder/results/results.json)
python3 "/autograder/$REPO_NAME/run_tests.py" \
  --assignment "$NAME" \
  --solution-dir "$DEST"
